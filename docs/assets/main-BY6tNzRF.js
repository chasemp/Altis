(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(t){if(t.ep)return;t.ep=!0;const s=n(t);fetch(t.href,s)}})();class l{constructor(){this.isSupported=this.checkSupport(),this.credentials=new Map,this.authCount=0,this.currentUserId=null,this.currentCredentialId=null}checkSupport(){return!!(navigator.credentials&&window.PublicKeyCredential)}generateChallenge(){const e=new Uint8Array(32);return crypto.getRandomValues(e),e}arrayBufferToBase64URL(e){const n=new Uint8Array(e);let i="";for(let t=0;t<n.byteLength;t++)i+=String.fromCharCode(n[t]);return btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}base64URLToArrayBuffer(e){const n=e.replace(/-/g,"+").replace(/_/g,"/"),i=atob(n),t=new Uint8Array(i.length);for(let s=0;s<i.length;s++)t[s]=i.charCodeAt(s);return t.buffer}async register(e=null){if(!this.isSupported)throw new Error("WebAuthn is not supported in this browser");try{e||(e="user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9));const i={publicKey:{challenge:this.generateChallenge(),rp:{name:"AltiraApp",id:window.location.hostname},user:{id:new TextEncoder().encode(e),name:e,displayName:"AltiraApp User"},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required"},timeout:6e4,attestation:"none"}},t=await navigator.credentials.create(i),s={id:t.id,rawId:this.arrayBufferToBase64URL(t.rawId),publicKey:this.arrayBufferToBase64URL(t.response.publicKey),userId:e,createdAt:new Date().toISOString()};return this.credentials.set(t.id,s),this.currentUserId=e,this.currentCredentialId=t.id,localStorage.setItem("altira_credentials",JSON.stringify(Array.from(this.credentials.entries()))),localStorage.setItem("altira_user_id",e),localStorage.setItem("altira_credential_id",t.id),{success:!0,credentialId:t.id,userId:e,message:"Biometric credential created successfully!"}}catch(n){throw console.error("Registration failed:",n),new Error(`Registration failed: ${n.message}`)}}async authenticate(){if(!this.isSupported)throw new Error("WebAuthn is not supported in this browser");try{if(this.loadStoredCredentials(),this.credentials.size===0)throw new Error("No credentials found. Please register first.");const e=this.generateChallenge(),n=Array.from(this.credentials.keys()).map(o=>this.base64URLToArrayBuffer(o)),i={publicKey:{challenge:e,allowCredentials:n.map(o=>({type:"public-key",id:o,transports:["internal"]})),userVerification:"required",timeout:6e4}},t=await navigator.credentials.get(i),s=this.arrayBufferToBase64URL(t.rawId),r=this.credentials.get(s);if(!r)throw new Error("Credential not found");return this.authCount++,this.currentUserId=r.userId,this.currentCredentialId=s,localStorage.setItem("altira_auth_count",this.authCount.toString()),{success:!0,credentialId:s,userId:r.userId,authCount:this.authCount,message:"Authentication successful!"}}catch(e){throw console.error("Authentication failed:",e),new Error(`Authentication failed: ${e.message}`)}}loadStoredCredentials(){try{const e=localStorage.getItem("altira_credentials");if(e){const s=JSON.parse(e);this.credentials=new Map(s)}const n=localStorage.getItem("altira_user_id"),i=localStorage.getItem("altira_credential_id"),t=localStorage.getItem("altira_auth_count");n&&(this.currentUserId=n),i&&(this.currentCredentialId=i),t&&(this.authCount=parseInt(t,10))}catch(e){console.error("Failed to load stored credentials:",e)}}isRegistered(){return this.loadStoredCredentials(),this.credentials.size>0}logout(){this.currentUserId=null,this.currentCredentialId=null,this.authCount=0,localStorage.removeItem("altira_user_id"),localStorage.removeItem("altira_credential_id"),localStorage.removeItem("altira_auth_count")}getCurrentUser(){return{userId:this.currentUserId,credentialId:this.currentCredentialId,authCount:this.authCount,isAuthenticated:!!this.currentUserId}}isAuthenticated(){return!!this.currentUserId}}class d{constructor(){this.webauthn=new l,this.elements=this.initializeElements(),this.initializeApp()}initializeElements(){return{statusIndicator:document.getElementById("status-indicator"),statusText:document.getElementById("status-text"),registerBtn:document.getElementById("register-btn"),authenticateBtn:document.getElementById("authenticate-btn"),logoutBtn:document.getElementById("logout-btn"),userInfo:document.getElementById("user-info"),userId:document.getElementById("user-id"),credentialId:document.getElementById("credential-id"),authCount:document.getElementById("auth-count"),authContainer:document.getElementById("auth-container"),content:document.getElementById("content")}}async initializeApp(){try{if(!this.webauthn.isSupported){this.updateStatus("error","WebAuthn not supported in this browser"),this.disableAllButtons();return}this.webauthn.loadStoredCredentials(),this.webauthn.isRegistered()?(this.updateStatus("loading","Checking authentication..."),this.webauthn.isAuthenticated()?this.showAuthenticatedState():this.showRegisteredState()):this.showUnregisteredState(),this.setupEventListeners()}catch(e){console.error("App initialization failed:",e),this.updateStatus("error","Initialization failed")}}setupEventListeners(){this.elements.registerBtn.addEventListener("click",()=>this.handleRegister()),this.elements.authenticateBtn.addEventListener("click",()=>this.handleAuthenticate()),this.elements.logoutBtn.addEventListener("click",()=>this.handleLogout())}async handleRegister(){try{this.updateStatus("loading","Creating biometric key..."),this.disableAllButtons();const e=await this.webauthn.register();e.success&&(this.updateStatus("authenticated","Biometric key created successfully!"),this.showAuthenticatedState(),this.showUserInfo(e.userId,e.credentialId))}catch(e){console.error("Registration error:",e),this.updateStatus("error",e.message),this.showRegisteredState()}}async handleAuthenticate(){try{this.updateStatus("loading","Authenticating with biometric..."),this.disableAllButtons();const e=await this.webauthn.authenticate();e.success&&(this.updateStatus("authenticated","Authentication successful!"),this.showAuthenticatedState(),this.showUserInfo(e.userId,e.credentialId,e.authCount))}catch(e){console.error("Authentication error:",e),this.updateStatus("error",e.message),this.showRegisteredState()}}handleLogout(){this.webauthn.logout(),this.updateStatus("loading","Logged out"),this.showRegisteredState()}updateStatus(e,n){this.elements.statusIndicator.className=`status-indicator ${e}`,this.elements.statusText.textContent=n,e==="loading"?this.disableAllButtons():e==="error"&&this.showRegisteredState()}showUnregisteredState(){this.elements.registerBtn.disabled=!1,this.elements.authenticateBtn.disabled=!0,this.elements.logoutBtn.disabled=!0,this.elements.userInfo.style.display="none",this.elements.content.style.display="none",this.elements.authContainer.style.display="block"}showRegisteredState(){this.elements.registerBtn.disabled=!0,this.elements.authenticateBtn.disabled=!1,this.elements.logoutBtn.disabled=!1,this.elements.userInfo.style.display="none",this.elements.content.style.display="none",this.elements.authContainer.style.display="block"}showAuthenticatedState(){this.elements.registerBtn.disabled=!0,this.elements.authenticateBtn.disabled=!0,this.elements.logoutBtn.disabled=!1,this.elements.userInfo.style.display="block",this.elements.content.style.display="block",this.elements.authContainer.style.display="none"}showUserInfo(e,n,i=0){this.elements.userId.textContent=e,this.elements.credentialId.textContent=n,this.elements.authCount.textContent=i}disableAllButtons(){this.elements.registerBtn.disabled=!0,this.elements.authenticateBtn.disabled=!0,this.elements.logoutBtn.disabled=!0}showNotification(e,n="info"){const i=document.createElement("div");i.className=`notification notification-${n}`,i.textContent=e,Object.assign(i.style,{position:"fixed",top:"20px",right:"20px",padding:"1rem 1.5rem",borderRadius:"10px",color:"white",fontWeight:"600",zIndex:"1000",maxWidth:"300px",wordWrap:"break-word",boxShadow:"0 10px 20px rgba(0, 0, 0, 0.2)",transform:"translateX(100%)",transition:"transform 0.3s ease"});const t={success:"#48bb78",error:"#f56565",info:"#4299e1",warning:"#ed8936"};i.style.backgroundColor=t[n]||t.info,document.body.appendChild(i),setTimeout(()=>{i.style.transform="translateX(0)"},100),setTimeout(()=>{i.style.transform="translateX(100%)",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300)},3e3)}}document.addEventListener("DOMContentLoaded",()=>{window.pwaApp=new d});window.addEventListener("beforeinstallprompt",a=>{a.preventDefault(),window.pwaApp&&window.pwaApp.showNotification("This app can be installed on your device!","info")});window.addEventListener("appinstalled",()=>{console.log("PWA was installed"),window.pwaApp&&window.pwaApp.showNotification("App installed successfully!","success")});window.addEventListener("online",()=>{window.pwaApp&&window.pwaApp.showNotification("You are back online!","success")});window.addEventListener("offline",()=>{window.pwaApp&&window.pwaApp.showNotification("You are offline. Some features may be limited.","warning")});
